# name: test/sql/firebird/15_timestamp_with_time_zone.test
# description: test for Firebird TIMESTAMP WITH TIME ZONE type (Firebird 4.0+)
# group: [firebird_timestamp_tz]

require odbc_scanner

statement ok
SET VARIABLE conn = odbc_connect('ODBCSCANNER_DEBUG_CONN_STRING_ENV_VAR=ODBC_CONN_STRING')

statement ok
CALL odbc_query(getvariable('conn'), "SET TIME ZONE 'America/Sao_Paulo'")

# Basic TIMESTAMP WITH TIME ZONE with offset
query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CAST(''2024-01-15 12:30:45 -03:00'' AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
----
2024-01-15 12:30:45

query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CAST(''2025-06-20 14:15:30 +05:30'' AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
----
2025-06-20 05:45:30

# TIMESTAMP WITH TIME ZONE with named zone
query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CAST(''2024-03-10 10:00:00 America/New_York'' AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
----
2024-03-10 11:00:00

query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CAST(''2024-07-15 15:45:00 Europe/London'' AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
----
2024-07-15 11:45:00

query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CAST(''2024-12-25 18:30:00 Asia/Tokyo'' AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
----
2024-12-25 06:30:00

# TIMESTAMP WITH TIME ZONE at UTC
query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CAST(''2024-01-01 12:00:00 GMT'' AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
----
2024-01-01 09:00:00

query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CAST(''2024-01-01 12:00:00 +00:00'' AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
----
2024-01-01 09:00:00

# CURRENT_TIMESTAMP with time zone (returns session time zone)
query I
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT CURRENT_TIMESTAMP FROM rdb$database')
----
<REGEX>:\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}

# Equivalence test - different time zones but same UTC time
query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CASE WHEN TIMESTAMP ''2024-01-15 10:00:00 -02:00'' = TIMESTAMP ''2024-01-15 09:00:00 -03:00'' THEN 1 ELSE 0 END FROM rdb$database')
----
1

# NULL value
query I
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT CAST(NULL AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
----
NULL

# Verify column type
query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'), 
    'SELECT CAST(''2024-01-15 12:30:45 -03:00'' AS TIMESTAMP WITH TIME ZONE) FROM rdb$database')
)
----
TIMESTAMP

# Arithmetic - add days to TIMESTAMP WITH TIME ZONE
query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT CAST(''2024-01-15 10:00:00 +00:00'' AS TIMESTAMP WITH TIME ZONE) + 1 FROM rdb$database')
----
2024-01-16 07:00:00

# Extract timezone information
query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT EXTRACT(TIMEZONE_HOUR FROM TIMESTAMP ''2024-01-15 12:30:00 -03:00'') FROM rdb$database')
----
-3

query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT EXTRACT(TIMEZONE_MINUTE FROM TIMESTAMP ''2024-01-15 12:30:00 +05:30'') FROM rdb$database')
----
30

# Combining DATE + TIME WITH TIME ZONE = TIMESTAMP WITH TIME ZONE
query I
SELECT * FROM odbc_query(getvariable('conn'), 
  'SELECT DATE ''2024-06-15'' + TIME ''14:30:00 +02:00'' FROM rdb$database')
----
2024-06-15 09:30:00

statement ok
CALL odbc_query(getvariable('conn'), "SET TIME ZONE 'UTC'")

statement ok
SELECT odbc_close(getvariable('conn'))
